<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ZenTyping</title>
    <script src="https://unpkg.com/pinyin-pro"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --bg-color: #323437; --main-color: #e2b714; --sub-color: #646669; --text-color: #d1d0c5; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'JetBrains Mono', 'PingFang SC', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        
        /* 顶部配置抽屉 */
        #config-drawer { position: fixed; top: 4px; width: 100%; background: rgba(0,0,0,0.85); padding: 12px; display: flex; gap: 10px; justify-content: center; transform: translateY(-96%); transition: transform 0.3s; z-index: 1000; border-bottom: 1px solid #444; }
        #config-drawer:hover { transform: translateY(0); }
        textarea { width: 500px; height: 50px; background: #1a1a1a; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 6px; resize: none; outline: none; font-family: inherit; }
        button { cursor: pointer; background: var(--main-color); border: none; padding: 0 25px; border-radius: 6px; font-weight: bold; color: var(--bg-color); }

        /* 进度条 */
        #progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: #2c2e31; z-index: 1001; }
        #progress-bar { height: 100%; width: 0%; background: var(--main-color); transition: width 0.3s; box-shadow: 0 0 10px var(--main-color); }

        /* 打字区域 */
        #typing-container { position: relative; max-width: 900px; font-size: 2.2rem; line-height: 1.8; letter-spacing: 4px; padding: 40px; }
        .char { color: var(--sub-color); display: inline-block; vertical-align: bottom; height: 3.8rem; transition: color 0.1s; }
        .correct { color: var(--text-color); }
        .incorrect { color: #ca4754; text-decoration: underline; text-underline-offset: 8px; }

        /* 拖尾光标 */
        #cursor-main { position: absolute; width: 3px; height: 2.8rem; background-color: var(--main-color); box-shadow: 0 0 12px var(--main-color); z-index: 10; pointer-events: none; transition: left 0.08s cubic-bezier(0.2, 0, 0, 1), top 0s; }
        .cursor-ghost { position: absolute; width: 3px; height: 2.8rem; background-color: var(--main-color); pointer-events: none; z-index: 5; animation: ghost-fade 0.45s ease-out forwards; }
        @keyframes ghost-fade { 0% { opacity: 0.6; } 100% { opacity: 0; transform: translateX(-20px); } }

        /* 拼音提示 */
        #ime-ghost { position: absolute; font-size: 1.2rem; color: var(--main-color); font-style: italic; opacity: 0.7; pointer-events: none; white-space: nowrap; }
        .stats { margin-top: 40px; color: var(--sub-color); font-size: 1rem; letter-spacing: 2px; }
    </style>
</head>
<body>
    <div id="progress-container"><div id="progress-bar"></div></div>
    
    <div id="config-drawer">
        <textarea id="input-text" placeholder="在此粘贴自定义文章（支持中英混排）..."></textarea>
        <button onclick="changeArticle()">载入文章</button>
    </div>

    <div id="typing-container">
        <div id="cursor-main"></div>
        <div id="text-canvas"></div>
        <div id="ime-ghost"></div>
    </div>

    <div class="stats">进度: <span id="percent">0</span>% | 已完成: <span id="count">0</span> / <span id="total">0</span></div>

<script>
    const { pinyin } = pinyinPro;
    
    // 默认文章：沁园春·雪
    let article = localStorage.getItem('zen_typing_v10') || "北国风光，千里冰封，万里雪飘。望长城内外，惟余莽莽；大河上下，顿失滔滔。山舞银蛇，原驰蜡象，欲与天公试比高。须晴日，看红装素裹，分外妖娆。江山如此多娇，引无数英雄竞折腰。惜秦皇汉武，略输文采；唐宗宋祖，稍逊风骚。一代天骄，成吉思汗，只识弯弓射大雕。俱往矣，数风流人物，还看今朝。";
    
    // 终极多音字及特殊输入补丁
    const PINYIN_PATCH = {
        "朝": ["zhao", "chao"],
        "略": ["lue", "lve"],
        "还": ["hai", "huan"],
        "数": ["shu"],
        "汗": ["han"],
        "佛": ["fo", "fu"],
        "行": ["xing", "hang"]
    };

    let articlePinyins = [], completedText = "", pinyinBuffer = "", isLocked = false, isAudioInitialized = false;

    const canvas = document.getElementById('text-canvas'), cursor = document.getElementById('cursor-main'), ghost = document.getElementById('ime-ghost'), bar = document.getElementById('progress-bar');
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // 音频预热逻辑
    function prewarmAudio() {
        if (isAudioInitialized) return;
        audioCtx.resume().then(() => {
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            g.gain.setValueAtTime(0, audioCtx.currentTime);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(0); o.stop(0.001);
            isAudioInitialized = true;
        });
    }

    function playKeySound(f=600, t='triangle', d=0.06) {
        if (!isAudioInitialized) prewarmAudio();
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.setValueAtTime(0.04, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + d);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + d);
    }

    function init() {
        canvas.innerHTML = ''; completedText = ""; pinyinBuffer = ""; window.done = false;
        
        // 生成全兼容拼音字典
        const raw = pinyin(article, { toneType: 'none', type: 'array', multiple: true });
        articlePinyins = raw.map((p, i) => {
            const char = article[i];
            let list = p.split(',').map(item => item.replace(/[ü]/g, 'v'));
            if (PINYIN_PATCH[char]) list = [...new Set([...list, ...PINYIN_PATCH[char]])];
            return list;
        });

        [...article].forEach(c => {
            const s = document.createElement('span'); s.innerText = c; s.className = 'char';
            canvas.appendChild(s);
        });
        document.getElementById('total').innerText = article.length;
        updateUI();
    }

    function updateUI(visualPinyin = "") {
        const idx = completedText.length, spans = canvas.querySelectorAll('.char');
        spans.forEach((s, i) => s.className = i < idx ? (completedText[i] === article[i] ? 'char correct' : 'char incorrect') : 'char');
        
        const target = spans[Math.min(idx, article.length - 1)];
        if (!target) return;

        let x = target.offsetLeft, y = target.offsetTop;
        if (idx >= article.length) x += target.offsetWidth;

        const fX = x + (visualPinyin.length * 9), oldX = parseFloat(cursor.style.left) || fX;
        
        if (Math.abs(oldX - fX) > 3) {
            const g = document.createElement('div'); g.className = 'cursor-ghost';
            g.style.left = oldX + 'px'; g.style.top = y + 'px';
            document.getElementById('typing-container').appendChild(g);
            setTimeout(() => g.remove(), 450);
        }

        cursor.style.left = fX + 'px'; cursor.style.top = y + 'px';
        bar.style.width = (idx / article.length * 100) + '%';
        document.getElementById('percent').innerText = Math.floor(idx / article.length * 100);
        document.getElementById('count').innerText = idx;
        ghost.innerText = visualPinyin; ghost.style.left = x + 'px'; ghost.style.top = (y + 68) + 'px';
        
        if (idx === article.length && !window.done) { 
            window.done = true; 
            confetti({particleCount: 200, spread: 80, origin: {y: 0.6}, colors: ['#e2b714', '#ffffff']});
        }
        if (idx % 12 === 0) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    window.addEventListener('keydown', (e) => {
        if (!isAudioInitialized) prewarmAudio();
        if (isLocked) return;
        
        const idx = completedText.length;
        if (idx >= article.length && e.key !== 'Backspace') return;
        const targetChar = article[idx];

        // 1. 退格
        if (e.key === 'Backspace') {
            playKeySound(420, 'sine', 0.1);
            if (pinyinBuffer) pinyinBuffer = pinyinBuffer.slice(0, -1);
            else completedText = completedText.slice(0, -1);
            updateUI(pinyinBuffer); return;
        }

        // 2. 标点与空格
        const puncs = { ',': '，', '.': '。', '!': '！', '?': '？', ':': '：', ';': '；', ' ': ' ' };
        if (e.key === targetChar || puncs[e.key] === targetChar) {
            playKeySound(e.key === ' ' ? 320 : 1100, e.key === ' ' ? 'square' : 'sine');
            completedText += targetChar; pinyinBuffer = ""; updateUI(""); return;
        }

        // 3. 拼音字母
        if (/^[a-z0-9]$/i.test(e.key)) {
            playKeySound(850 + Math.random()*150);
            if (/[\u4e00-\u9fa5]/.test(targetChar)) {
                pinyinBuffer += e.key.toLowerCase();
                let norm = pinyinBuffer.replace('u', 'v');
                let matches = articlePinyins[idx].some(p => p === pinyinBuffer || p === norm);
                
                if (matches) {
                    isLocked = true; updateUI(pinyinBuffer);
                    setTimeout(() => { completedText += targetChar; pinyinBuffer = ""; isLocked = false; updateUI(""); }, 65);
                } else updateUI(pinyinBuffer);
            } else {
                // 英文模式
                completedText += targetChar; pinyinBuffer = ""; updateUI("");
            }
        }
    });

    function changeArticle() {
        const val = document.getElementById('input-text').value.trim();
        if (val) { article = val; localStorage.setItem('zen_typing_v10', val); init(); }
    }

    document.getElementById('input-text').value = article;
    init();
    document.addEventListener('mousedown', prewarmAudio);
    document.addEventListener('click', (e) => { if(e.target.tagName !== 'TEXTAREA') window.focus(); });
</script>
</body>
</html>